<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core - Job Aggregator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-error { background-color: #f59e0b; }
        .status-unknown { background-color: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div x-data="dashboard()" x-init="init()" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white">Core - Job Aggregator</h1>
            <p class="text-gray-400 mt-1">Palantir-inspired job data integration platform</p>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-sm">Total Jobs</p>
                <p class="text-2xl font-bold" x-text="stats.total_jobs">0</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-sm">Jobs Today</p>
                <p class="text-2xl font-bold" x-text="stats.jobs_today">0</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-sm">Active Sources</p>
                <p class="text-2xl font-bold" x-text="connectors.filter(c => c.status === 'online').length">0</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                <p class="text-gray-400 text-sm">Last Sync</p>
                <p class="text-lg font-medium" x-text="stats.last_sync ? new Date(stats.last_sync).toLocaleString() : 'Never'">-</p>
            </div>
        </div>

        <!-- API Status Cards -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">API Connectors</h2>
                <div class="space-x-2">
                    <button @click="checkAllStatus()"
                            class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm"
                            :disabled="loading.status">
                        <span x-show="!loading.status">Refresh Status</span>
                        <span x-show="loading.status">Checking...</span>
                    </button>
                    <button @click="syncAll()"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm"
                            :disabled="loading.sync">
                        <span x-show="!loading.sync">Sync All</span>
                        <span x-show="loading.sync">Syncing...</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <template x-for="connector in connectors" :key="connector.source">
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="font-semibold text-lg" x-text="connector.name"></h3>
                                <p class="text-gray-400 text-sm" x-text="connector.source"></p>
                            </div>
                            <span class="px-2 py-1 rounded text-xs font-medium text-white"
                                  :class="'status-' + connector.status"
                                  x-text="connector.status.toUpperCase()">
                            </span>
                        </div>
                        <div class="text-sm text-gray-400 mb-3">
                            <span x-show="connector.job_count !== null">
                                <span x-text="connector.job_count?.toLocaleString()"></span> jobs available
                            </span>
                            <span x-show="connector.error_message" class="text-red-400" x-text="connector.error_message"></span>
                        </div>
                        <button @click="syncSource(connector.source)"
                                class="w-full px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm"
                                :disabled="loading.sync">
                            Sync Jobs
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Search & Filters -->
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm text-gray-400 mb-1">Search</label>
                    <input type="text" x-model="filters.search" @keyup.enter="loadJobs()"
                           class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:outline-none focus:border-blue-500"
                           placeholder="Job title or company...">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Source</label>
                    <select x-model="filters.source" @change="loadJobs()"
                            class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded focus:outline-none focus:border-blue-500">
                        <option value="">All Sources</option>
                        <option value="bundesagentur">Bundesagentur</option>
                        <option value="remoteok">RemoteOK</option>
                        <option value="remotive">Remotive</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" x-model="filters.remote_only" @change="loadJobs()"
                               class="w-4 h-4 rounded bg-gray-900 border-gray-700">
                        <span class="text-sm">Remote Only</span>
                    </label>
                </div>
                <div class="flex items-end">
                    <button @click="loadJobs()" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded">
                        Search
                    </button>
                </div>
            </div>
        </div>

        <!-- Jobs Table -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-semibold">Jobs (<span x-text="jobsData.total">0</span>)</h2>
                <div class="text-sm text-gray-400">
                    Page <span x-text="jobsData.page">1</span> of <span x-text="jobsData.total_pages">1</span>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-900">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Title</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Company</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Location</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Type</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Source</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Posted</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <template x-for="job in jobsData.jobs" :key="job.id">
                            <tr class="hover:bg-gray-700/50">
                                <td class="px-4 py-3">
                                    <a :href="job.url" target="_blank" class="text-blue-400 hover:text-blue-300" x-text="job.title"></a>
                                </td>
                                <td class="px-4 py-3 text-gray-300" x-text="job.company_name"></td>
                                <td class="px-4 py-3 text-gray-400 text-sm" x-text="job.location || '-'"></td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs rounded"
                                          :class="job.remote_type === 'remote' ? 'bg-green-900 text-green-300' : 'bg-gray-700 text-gray-300'"
                                          x-text="job.remote_type || '-'">
                                    </span>
                                </td>
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs bg-gray-700 rounded" x-text="job.source"></span>
                                </td>
                                <td class="px-4 py-3 text-gray-400 text-sm" x-text="job.posted_at ? new Date(job.posted_at).toLocaleDateString() : '-'"></td>
                                <td class="px-4 py-3">
                                    <button @click="deleteJob(job.id)" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="jobsData.jobs.length === 0">
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                No jobs found. Sync some jobs to get started.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="p-4 border-t border-gray-700 flex justify-between items-center" x-show="jobsData.total_pages > 1">
                <button @click="prevPage()" :disabled="jobsData.page <= 1"
                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                </button>
                <div class="flex space-x-2">
                    <template x-for="p in Math.min(5, jobsData.total_pages)">
                        <button @click="goToPage(p)"
                                class="px-3 py-1 rounded"
                                :class="p === jobsData.page ? 'bg-blue-600' : 'bg-gray-700 hover:bg-gray-600'"
                                x-text="p">
                        </button>
                    </template>
                </div>
                <button @click="nextPage()" :disabled="jobsData.page >= jobsData.total_pages"
                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                </button>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div x-show="toast.show" x-cloak
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-y-2"
             x-transition:enter-end="opacity-100 transform translate-y-0"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg"
             :class="toast.type === 'error' ? 'bg-red-600' : 'bg-green-600'">
            <p x-text="toast.message"></p>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                stats: {
                    total_jobs: 0,
                    jobs_by_source: {},
                    jobs_today: 0,
                    last_sync: null
                },
                connectors: [],
                jobsData: {
                    jobs: [],
                    total: 0,
                    page: 1,
                    page_size: 25,
                    total_pages: 1
                },
                filters: {
                    search: '',
                    source: '',
                    remote_only: false
                },
                loading: {
                    status: false,
                    sync: false,
                    jobs: false
                },
                toast: {
                    show: false,
                    message: '',
                    type: 'success'
                },

                async init() {
                    await Promise.all([
                        this.checkAllStatus(),
                        this.loadStats(),
                        this.loadJobs()
                    ]);
                },

                async checkAllStatus() {
                    this.loading.status = true;
                    try {
                        const response = await fetch('/api/connectors/status');
                        this.connectors = await response.json();
                    } catch (error) {
                        this.showToast('Failed to check status: ' + error.message, 'error');
                    }
                    this.loading.status = false;
                },

                async loadStats() {
                    try {
                        const response = await fetch('/api/jobs/stats');
                        this.stats = await response.json();
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },

                async loadJobs() {
                    this.loading.jobs = true;
                    try {
                        const params = new URLSearchParams({
                            page: this.jobsData.page,
                            page_size: this.jobsData.page_size
                        });
                        if (this.filters.search) params.append('search', this.filters.search);
                        if (this.filters.source) params.append('source', this.filters.source);
                        if (this.filters.remote_only) params.append('remote_only', 'true');

                        const response = await fetch('/api/jobs?' + params);
                        this.jobsData = await response.json();
                    } catch (error) {
                        this.showToast('Failed to load jobs: ' + error.message, 'error');
                    }
                    this.loading.jobs = false;
                },

                async syncSource(source) {
                    this.loading.sync = true;
                    try {
                        const response = await fetch(`/api/connectors/${source}/sync`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source, max_pages: 2 })
                        });
                        const result = await response.json();
                        this.showToast(`Synced ${result.jobs_saved} new jobs from ${source}`, 'success');
                        await Promise.all([this.loadStats(), this.loadJobs()]);
                    } catch (error) {
                        this.showToast('Sync failed: ' + error.message, 'error');
                    }
                    this.loading.sync = false;
                },

                async syncAll() {
                    this.loading.sync = true;
                    try {
                        const response = await fetch('/api/connectors/sync-all?max_pages=2', {
                            method: 'POST'
                        });
                        const results = await response.json();
                        const total = results.reduce((sum, r) => sum + r.jobs_saved, 0);
                        this.showToast(`Synced ${total} new jobs from all sources`, 'success');
                        await Promise.all([this.loadStats(), this.loadJobs()]);
                    } catch (error) {
                        this.showToast('Sync failed: ' + error.message, 'error');
                    }
                    this.loading.sync = false;
                },

                async deleteJob(id) {
                    if (!confirm('Delete this job?')) return;
                    try {
                        await fetch(`/api/jobs/${id}`, { method: 'DELETE' });
                        this.showToast('Job deleted', 'success');
                        await Promise.all([this.loadStats(), this.loadJobs()]);
                    } catch (error) {
                        this.showToast('Delete failed: ' + error.message, 'error');
                    }
                },

                prevPage() {
                    if (this.jobsData.page > 1) {
                        this.jobsData.page--;
                        this.loadJobs();
                    }
                },

                nextPage() {
                    if (this.jobsData.page < this.jobsData.total_pages) {
                        this.jobsData.page++;
                        this.loadJobs();
                    }
                },

                goToPage(p) {
                    this.jobsData.page = p;
                    this.loadJobs();
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 3000);
                }
            };
        }
    </script>
</body>
</html>
